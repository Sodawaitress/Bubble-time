{% extends "layout.html" %}{% block head %}<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" /><script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script><script src="https://cdn.jsdelivr.net/npm/rrule@2.7.2/dist/es5/rrule-tz.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.15/index.global.min.js"></script>{% endblock %}{% block content %}{% if not session.get('user') %}<div class="card"><h2>欢迎</h2><p>请先 <a href="/login">登录</a> 或 <a href="/register">注册</a>。</p></div>{% else %}<div class="toolbar"><div><button id="prevBtn">←</button><button id="todayBtn">今天</button><button id="nextBtn">→</button></div><div><select id="viewSelect"><option value="timeGridDay">Day</option><option value="timeGridThreeDay">3 Days</option><option value="timeGridSevenDay">7 Days</option><option value="dayGridMonth">Month</option></select></div></div><div id="calendar"></div><dialog id="eventDialog"><form method="dialog" id="eventForm" class="form"><h3 id="dlgTitle">新事件</h3><input type="hidden" name="id" id="evtId"><label>标题 <input type="text" name="title" id="evtTitle" required></label><label>备注 <textarea name="notes" id="evtNotes"></textarea></label><label>重复<select id="evtRepeat"><option value="">不重复</option><option value="DAILY">每天</option><option value="WEEKLY">每周（同一天）</option></select></label><menu class="dialog-actions"><button value="cancel">取消</button><button id="saveBtn" value="default">保存</button></menu></form></dialog><script>const user = {{ session.get('user')|tojson }};const userSettings = {timezone: user.timezone || 'Asia/Shanghai',start: (user.dayStart || '07:40') + ':00',end: (user.dayEnd || '22:00') + ':00',granularity: (user.slotGranularity || 5)};const calendarEl = document.getElementById('calendar');const dialogEl = document.getElementById('eventDialog');const formEl = document.getElementById('eventForm');const viewSelect = document.getElementById('viewSelect');const calendar = new FullCalendar.Calendar(calendarEl, {timeZone: userSettings.timezone,initialView: 'timeGridDay',headerToolbar: false,selectable: true,editable: true,slotMinTime: userSettings.start,slotMaxTime: userSettings.end,slotDuration: `00:${String(userSettings.granularity).padStart(2,'0')}:00`,expandRows: true,nowIndicator: true,height: 'auto',views: {timeGridThreeDay: { type: 'timeGrid', duration: { days: 3 } },timeGridSevenDay: { type: 'timeGrid', duration: { days: 7 } }},eventSources: [{url: '/api/events',method: 'GET',failure: () => alert('加载事件失败')}],select: async (info) => {formEl.reset();document.getElementById('evtId').value='';document.getElementById('evtTitle').value='';document.getElementById('evtNotes').value='';document.getElementById('evtRepeat').value='';dialogEl.showModal();formEl.onsubmit = async (e) => {e.preventDefault();const payload = {title: document.getElementById('evtTitle').value,notes: document.getElementById('evtNotes').value,start: info.startStr,end: info.endStr,rrule: (()=>{const v = document.getElementById('evtRepeat').value;if(!v) return null;const rule = { freq: v, dtstart: info.startStr };return rule;})()};const res = await fetch('/api/events', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});if(res.ok){ calendar.refetchEvents(); dialogEl.close(); } else alert('创建失败');};},eventDrop: async (info) => {await updateEventTime(info);},eventResize: async (info) => {await updateEventTime(info);},eventClick: (info) => {const action = window.prompt('输入 d 删除；e 编辑；x 仅删除这一次', 'e');if(action === 'd'){fetch(`/api/events/${info.event.id}`, {method:'DELETE'}).then(r=>{ if(r.ok) info.event.remove(); else alert('删除失败'); });} else if(action === 'x'){fetch(`/api/events/${info.event.id}?exdate=${encodeURIComponent(info.event.startStr)}`, {method:'DELETE'}).then(r=>{ if(r.ok) calendar.refetchEvents(); else alert('删除失败'); });} else if(action === 'e'){formEl.reset();document.getElementById('evtId').value=info.event.id;document.getElementById('evtTitle').value=info.event.title;document.getElementById('evtNotes').value=info.event.extendedProps.notes || '';document.getElementById('evtRepeat').value=info.event.extendedProps.rrule? info.event.extendedProps.rrule.freq: '';dialogEl.showModal();formEl.onsubmit = async (e) => {e.preventDefault();const payload = {title: document.getElementById('evtTitle').value,notes: document.getElementById('evtNotes').value,rrule: (()=>{const v = document.getElementById('evtRepeat').value;if(!v) return null;const rule = { freq: v, dtstart: info.event.startStr };return rule;})()};const res = await fetch(`/api/events/${info.event.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});if(res.ok){ calendar.refetchEvents(); dialogEl.close(); } else alert('更新失败');};}}});async function updateEventTime(info){const payload = { start: info.event.startStr, end: info.event.endStr };const res = await fetch(`/api/events/${info.event.id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});if(!res.ok){ alert('保存失败'); info.revert(); }}document.getElementById('prevBtn').onclick = ()=>calendar.prev();document.getElementById('nextBtn').onclick = ()=>calendar.next();document.getElementById('todayBtn').onclick = ()=>calendar.today();viewSelect.onchange = ()=>calendar.changeView(viewSelect.value);calendar.render();</script>{% endif %}{% endblock %}