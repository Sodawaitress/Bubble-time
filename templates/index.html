{% raw %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/gif" href="/static/animated.gif">
  <title>BubbleTime</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{background:#fff;color:#000}
    .btn { border:2px solid #000; padding:.5rem .75rem; }
    .btn:hover { background:#000; color:#fff }
    .btn-ghost:hover { background:#eee; color:#000 }
    .dialog { border:4px solid #000; }
    .rubber { position:absolute; background:rgba(0,0,0,.08); border:2px dashed #000; pointer-events:none; }
    .timecol { width:64px; }
    .gridcol { left:64px; right:8px; position:absolute; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
  const formatDate = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const {useState, useEffect, useMemo, useRef} = React;

  const pad = (n)=> String(n).padStart(2,'0');
  // Êú¨Âú∞Êó•ÊúüÂ≠óÁ¨¶‰∏≤Ôºà‰∏çÂÜçÁî® toISOString ÈÅøÂÖçË¢´ UTC ÂÅèÁßªÔºâ
  const ymd = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  // Êää‚ÄúÊú¨Âú∞ÁöÑ yyyy-mm-dd hh:mm‚ÄùËΩ¨Êàê ISOÔºàÂêéÁ´ØÂ≠ò UTCÔºâ
  const toISO = (dateStr, timeStr)=> {
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    const dt = new Date(y, m-1, d, hh, mm, 0);  // Êú¨Âú∞Êó∂Èó¥
    return dt.toISOString();
  };

  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

  async function httpJSON(url, opts={}){
    const res = await fetch(url, {credentials:'include', ...opts});
    if (res.redirected && res.url.includes('/login')) {
        window.location.href = res.url;
        return;
    }
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
    }
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  function Header({view, setView, timeSettings, setShowTimeSettings, navigate, date}){
    return (
      <div className="border-b-2 border-black pb-4 mb-6">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-7 h-7 border-2 border-black flex items-center justify-center font-bold">üìÖ</div>
            <h1 className="text-2xl font-bold">Calendar</h1>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={()=>setShowTimeSettings(true)} className="btn btn-ghost flex items-center gap-2">
              ‚è± {pad(timeSettings.startHour)}:00‚Äì{pad(timeSettings.endHour)}:00
            </button>
            <div className="flex border-2 border-black">
              {['day','3day','week','month'].map(k=> (
                <button key={k}
                  onClick={()=>setView(k)}
                  className={`px-4 py-2 border-r-2 border-black last:border-r-0 ${view===k?'bg-black text-white':'hover:bg-gray-100'}`}>
                  {{day:'Êó•', '3day':'3Â§©', week:'Âë®', month:'Êúà'}[k]}
                </button>
              ))}
            </div>
            <button onClick={()=>navigate(-1)} className="btn btn-ghost">‚Üê</button>
            <button onClick={()=>navigate(1)} className="btn btn-ghost">‚Üí</button>
          </div>
        </div>
      </div>
    )
  }

  function TimeGridDay({date, events, onCreateRange, onEventClick, timeSettings}){
    const hours = useMemo(()=>{
      const arr=[]; const {startHour,endHour}=timeSettings;
      if(startHour<=endHour){ for(let h=startHour;h<=endHour;h++) arr.push(h); }
      else { for(let h=startHour;h<24;h++) arr.push(h); for(let h=0;h<=endHour;h++) arr.push(h); }
      return arr;
    },[timeSettings]);
    const wrapRef = useRef(null);
    const rbRef = useRef(null);
    const stateRef = useRef({dragging:false, startY:0, startHM:'', dateStr: ymd(date)});

    const dateStr = ymd(date);
    const todayStr = ymd(new Date());

    function hmFromY(y){
      const rect = wrapRef.current.getBoundingClientRect();
      const relY = clamp(y - rect.top, 0, rect.height-1);
      const minute = Math.round((relY % 60)/5)*5;
      const hourIdx = Math.floor(relY/60);
      const h = hours[Math.min(hourIdx, hours.length-1)];
      return pad(h)+':'+pad(minute);
    }

    function onMouseDown(e){
      // Âè™ÂÖÅËÆ∏Âú®ÁΩëÊ†ºÂàóÂºÄÂßãÈÄâÊã©ÔºàÈÅøÂºÄÂ∑¶‰æßÊó∂Èó¥ÂàóÔºâ
      const container = wrapRef.current;
      if(!container) return;
      const rect = container.getBoundingClientRect();
      if(e.clientX - rect.left < 64) return; // Âú®Êó∂Èó¥ÂàóÔºåÂøΩÁï•
      stateRef.current.dragging = true;
      stateRef.current.startY = e.clientY;
      stateRef.current.startHM = hmFromY(e.clientY);
      stateRef.current.dateStr = dateStr;
      const rb = rbRef.current;
      if(rb){
        rb.style.display = 'block';
        rb.style.left = '68px';
        rb.style.right = '8px';
        rb.style.top = (e.clientY - rect.top) + 'px';
        rb.style.height = '2px';
      }
      e.preventDefault();
    }

    function onMouseMove(e){
      if(!stateRef.current.dragging) return;
      const container = wrapRef.current;
      const rect = container.getBoundingClientRect();
      const y0 = stateRef.current.startY;
      const y1 = e.clientY;
      const top = Math.min(y0,y1) - rect.top;
      let height = Math.abs(y1 - y0);
      const rb = rbRef.current;
      if(rb){
        rb.style.top = clamp(top, 0, rect.height-2) + 'px';
        rb.style.height = Math.max(2, height) + 'px';
      }
      e.preventDefault();
    }

    function onMouseUp(e){
      if(!stateRef.current.dragging) return;
      const container = wrapRef.current;
      const rect = container.getBoundingClientRect();
      const y0 = stateRef.current.startY;
      const y1 = e.clientY;
      const moved = Math.abs(y1 - y0);
      stateRef.current.dragging = false;
      const rb = rbRef.current;
      if(rb){ rb.style.display='none'; }
      if(moved < 6){
        // Â§™Â∞èÁöÑÊãñÂä®ÔºåÂΩì‰ΩúÂèñÊ∂àÔºà‰∏çÁ≤óÈ≤ÅÂºπÁ™óÔºâ
        return;
      }
      const startHM = hmFromY(Math.min(y0,y1));
      let endHM = hmFromY(Math.max(y0,y1));
      // Ëá≥Â∞ë 5 ÂàÜÈíü
      const [sh,sm] = startHM.split(':').map(Number);
      const [eh,em] = endHM.split(':').map(Number);
      let sMins = sh*60+sm, eMins = eh*60+em;
      if(eMins <= sMins) eMins = sMins + 5;
      endHM = pad(Math.floor(eMins/60)) + ':' + pad(eMins%60);
      onCreateRange(stateRef.current.dateStr, startHM, endHM);
    }

    return (
      <div className="border-2 border-black bg-white">
        <div className="relative select-none"
             ref={wrapRef}
             style={{height: (hours.length*60)+'px'}}
             onMouseDown={onMouseDown}
             onMouseMove={onMouseMove}
             onMouseUp={onMouseUp}
        >
          <div ref={rbRef} className="rubber" style={{display:'none'}}></div>

          {hours.map((h)=> (
            <div key={h} className="relative" style={{height:'60px'}}>
              <div className="absolute w-full border-t border-gray-400" style={{top:0}}/>
              <div className="absolute left-0 top-0 timecol h-full bg-gray-50 border-r border-black flex items-start pt-1 px-2">
                <span className="px-3 py-2 border-2 border-black">{formatDate(date)}</span>

                <span className="text-xs font-mono">{h===0?'12AM':h<12?`${h}AM`:h===12?'12PM':`${h-12}PM`}</span>
              </div>
              <div className="absolute gridcol top-0 h-full">
                <div className="absolute w-full border-t border-gray-300" style={{top:'30px'}}/>
                {[15,45].map(m=> (
                  <div key={m} className="absolute left-0 w-3 border-t border-gray-400" style={{top:`${m}px`}}/>
                ))}
              </div>
            </div>
          ))}

          {events.filter(ev=> ev.date===dateStr).map(ev=>{
            const [sh,sm]=ev.time.split(':').map(Number);
            const [eh,em]=(ev.endTime||ev.time).split(':').map(Number);
            const si = hours.indexOf(sh); if(si===-1) return null;
            const ei = hours.indexOf(eh);
            const sy = si*60 + sm, ey = (ei!==-1? ei*60+em : sy+60);
            const h = Math.max(ey-sy, 25);
            return (
              <div key={ev.id} onClick={(e)=>{e.stopPropagation(); onEventClick(ev);}}
                className="absolute z-10 border-2 border-black bg-gray-200 hover:bg-gray-300 cursor-pointer"
                style={{left:'68px', right:'8px', top: (sy+1)+'px', height:(h-2)+'px'}}>
                <div className="p-1.5 h-full overflow-hidden">
                  <div className="font-bold text-sm truncate">{ev.title}</div>
                  {h>35 && <div className="text-xs">{ev.time} - {ev.endTime}</div>}
                </div>
              </div>
            )
          })}

          {dateStr===todayStr && (()=>{
            const now = new Date(); const h=now.getHours(); const i=hours.indexOf(h);
            if(i===-1) return null;
            const y = i*60 + now.getMinutes();
            return (<>
              <div className="absolute z-30 border-t-2 border-black" style={{top:y+'px', left:'64px', right:0}}/>
              <div className="absolute z-30 rounded-full bg-black" style={{top:(y-4)+'px', left:'56px', width:'8px', height:'8px'}}/>
            </>);
          })()}
        </div>
      </div>
    )
  }

  function App(){
    const [view, setView] = useState('day');
    const [date, setDate] = useState(new Date());
    const [events, setEvents] = useState([]);
    const [formOpen, setFormOpen] = useState(false);
    const [editing, setEditing] = useState(null);
    const [form, setForm] = useState({title:'', date: ymd(new Date()), time:'09:00', endTime:'10:00', notes:'', repeat:'none'});
    const [timeSettings, setTimeSettings] = useState({ startHour: 7, endHour: 22 });
    const [showTimeSettings, setShowTimeSettings] = useState(false);
    const [loading, setLoading] = useState(false);

    const load = async()=>{
      setLoading(true);
      try{
        const start = new Date(); start.setDate(start.getDate()-45);
        const end = new Date(); end.setDate(end.getDate()+90);
        const q = new URLSearchParams({ start: start.toISOString(), end: end.toISOString() }).toString();
        const arr = await httpJSON('/api/events?'+q);
        const mapped = arr.map(e=>{
          const s = new Date(e.start);
          const ee = new Date(e.end);
          const p = (n)=> String(n).padStart(2,'0');
          return {
            id: e.id, title: e.title||'', notes:e.notes||'',
            date: ymd(s),
            time: p(s.getHours())+':'+p(s.getMinutes()),
            endTime: p(ee.getHours())+':'+p(ee.getMinutes()),
            rrule: e.rrule || null
          };
        });
        setEvents(mapped);
      }catch(err){
        console.error(err);
        alert('Âä†ËΩΩ‰∫ã‰ª∂Â§±Ë¥•Ôºö'+err.message);
      }finally{
        setLoading(false);
      }
    };
    useEffect(()=>{ load(); },[]);

    const navigate = (dir)=>{
      const d = new Date(date);
      if(view==='day'){ d.setDate(d.getDate()+dir); }
      else if(view==='3day'){ d.setDate(d.getDate()+3*dir); }
      else if(view==='week'){ d.setDate(d.getDate()+7*dir); }
      else { d.setMonth(d.getMonth()+dir); }
      setDate(d);
    };

    const openCreateFromDrag = (dateStr, startHM, endHM)=>{
      setEditing(null);
      setForm({ title:'', date:dateStr, time:startHM, endTime:endHM, notes:'', repeat:'none'});
      setFormOpen(true);
    };

    const save = async()=>{
      const payload = {
        title: form.title,
        notes: form.notes || '',
        start: toISO(form.date, form.time),
        end: toISO(form.date, form.endTime),
        rrule: (form.repeat==='none') ? null : { freq: form.repeat.toUpperCase(), dtstart: toISO(form.date, form.time) }
      };
      try{
        if(new Date(payload.end) <= new Date(payload.start)){
          // ÊúÄÂ∞è 5 ÂàÜÈíü
          const dt = new Date(payload.start);
          dt.setMinutes(dt.getMinutes()+5);
          payload.end = dt.toISOString();
        }
        if(editing){
          await httpJSON('/api/events/'+editing.id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }else{
          await httpJSON('/api/events', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }
        setFormOpen(false); setEditing(null);
        await load();
      }catch(err){
        console.error(err);
        alert('‰øùÂ≠òÂ§±Ë¥•Ôºö'+err.message);
      }
    };

    const remove = async(onlyThis=false)=>{
      if(!editing) return;
      try{
        const dateISO = toISO(editing.date, editing.time);
        const url = onlyThis
          ? `/api/events/${editing.id}?exdate=${encodeURIComponent(dateISO)}`
          : `/api/events/${editing.id}`;
        await httpJSON(url, {method:'DELETE'});
        setFormOpen(false); setEditing(null);
        await load();
      }catch(err){
        console.error(err);
        alert('Âà†Èô§Â§±Ë¥•Ôºö'+err.message);
      }
    };

    return (
      <div className="min-h-screen bg-white">
        <div className="max-w-6xl mx-auto p-4">
          <Header
            view={view}
            setView={setView}
            timeSettings={timeSettings}
            setShowTimeSettings={setShowTimeSettings}
            navigate={navigate}
            date={date}
          />

          {loading && <div className="text-sm text-gray-600 mb-2">Âä†ËΩΩ‰∏≠‚Ä¶</div>}
          <TimeGridDay
            date={date}
            events={events}
            timeSettings={timeSettings}
            onCreateRange={openCreateFromDrag}
            onEventClick={(ev)=>{ setEditing(ev); setForm({...ev, repeat: ev.rrule? ev.rrule.freq.toLowerCase():'none'}); setFormOpen(true); }}
          />
        </div>

        {showTimeSettings && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify‰∏≠ÂøÉ p-4 z-50">
            <div className="bg-white dialog p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">Êó∂Èó¥ËÆæÁΩÆ</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">ÂºÄÂßã</label>
                  <select className="w-full border-2 border-black p-2"
                    value={timeSettings.startHour}
                    onChange={e=> setTimeSettings(s=>({...s, startHour: parseInt(e.target.value)}))}>
                    {Array.from({length:24}, (_,h)=> <option key={h} value={h}>{String(h).padStart(2,'0')}:00</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">ÁªìÊùü</label>
                  <select className="w-full border-2 border-black p-2"
                    value={timeSettings.endHour}
                    onChange={e=> setTimeSettings(s=>({...s, endHour: parseInt(e.target.value)}))}>
                    {Array.from({length:24}, (_,h)=> <option key={h} value={h}>{String(h).padStart(2,'0')}:00</option>)}
                  </select>
                </div>
              </div>
              <div className="flex gap-3 mt-6">
                <button className="btn btn-ghost flex-1" onClick={()=> setShowTimeSettings(false)}>ÂèñÊ∂à</button>
                <button className="btn flex-1" onClick={()=> setShowTimeSettings(false)}>‰øùÂ≠ò</button>
              </div>
            </div>
          </div>
        )}

        {formOpen && (
          <div className="fixed inset-0 bgÈªë/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dialog p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">{editing? 'ÁºñËæë‰∫ã‰ª∂':'Êñ∞‰∫ã‰ª∂'}</h3>
              <div className="grid gap-3">
                <label className="text-sm font-bold">Ê†áÈ¢ò
                  <input className="w-full border-2 border-black p-2" value={form.title}
                         onChange={e=> setForm({...form, title:e.target.value})} placeholder="‰∫ã‰ª∂Ê†áÈ¢ò"/>
                </label>
                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm font-bold">Êó•Êúü
                    <input type="date" className="w-full border-2 border-black p-2" value={form.date}
                           onChange={e=> setForm({...form, date:e.target.value})}/>
                  </label>
                  <label className="text-sm font-bold">ÈáçÂ§ç
                    <select className="w-full border-2 border-black p-2" value={form.repeat}
                            onChange={e=> setForm({...form, repeat:e.target.value})}>
                      <option value="none">‰∏çÈáçÂ§ç</option>
                      <option value="daily">ÊØèÂ§©</option>
                      <option value="weekly">ÊØèÂë®</option>
                    </select>
                  </label>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm font-bold">ÂºÄÂßã
                    <input type="time" className="w-full border-2 border-black p-2" value={form.time}
                           onChange={e=> setForm({...form, time:e.target.value})}/>
                  </label>
                  <label className="text-sm font-bold">ÁªìÊùü
                    <input type="time" className="w-full border-2 border-black p-2" value={form.endTime}
                           onChange={e=> setForm({...form, endTime:e.target.value})}/>
                  </label>
                </div>
                <label className="text-sm font-bold">Â§áÊ≥®
                  <textarea className="w-full border-2 border-black p-2 h-20 resize-none" value={form.notes}
                            onChange={e=> setForm({...form, notes:e.target.value})}/>
                </label>
              </div>
              <div className="flex gap-3 mt-6">
                <button className="btn btn-ghost flex-1"
                  onClick={()=> { setFormOpen(false); setEditing(null); }}>
                  ÂèñÊ∂à
                </button>
                {editing && (
                  <button className="btn flex-none" onClick={()=> remove(false)}>Âà†Èô§</button>
                )}
                {editing && editing.rrule && (
                  <button className="btn flex-none" onClick={()=> remove(true)}>‰ªÖÂà†Ëøô‰∏ÄÊ¨°</button>
                )}
                <button className="btn flex-1" onClick={save} disabled={!form.title.trim()}>
                  {editing? '‰øùÂ≠ò':'ÂàõÂª∫'}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
{% endraw %}
