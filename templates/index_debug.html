<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BubbleTime</title>
  <!-- 可选：把 animated.gif 放到 /static/animated.gif -->
  <link rel="icon" type="image/gif" href="/static/animated.gif">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{background:#fff;color:#000}
    .btn { border:2px solid #000; padding:.5rem .75rem; }
    .btn:hover { background:#000; color:#fff }
    .btn-ghost:hover { background:#eee; color:#000 }
    .dialog { border:4px solid #000; }
    .rubber { position:absolute; background:rgba(0,0,0,.08); border:2px dashed #000; pointer-events:none; }
    .timecol { width:64px; }
    .sticky-top { position: sticky; top: 0; background:#fff; z-index: 5; }
  </style>
</head>
<body>
  <div id="app"></div>

  {% raw %}
<script type="text/babel">
  const {useState, useEffect, useMemo, useRef} = React;

  // ---------- Utils ----------
  const pad = (n)=> String(n).padStart(2,'0');
  const ymd = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const toISO = (dateStr, timeStr)=> {
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    const dt = new Date(y, m-1, d, hh, mm, 0); // 本地 -> ISO(UTC)
    return dt.toISOString();
  };
  const fromISO = (iso)=> new Date(iso);
  const addDays = (date, days)=> { const d=new Date(date); d.setDate(d.getDate()+days); return d; };
  // 周一为一周第一天
  const startOfWeek = (d)=> {
    const r = new Date(d);
    const day = (r.getDay() + 6) % 7; // 0=周一,6=周日
    r.setDate(r.getDate() - day);
    r.setHours(0,0,0,0);
    return r;
  };
  // 月历矩阵（周一开头，6x7）
  const monthMatrix = (cur)=> {
    const first = new Date(cur.getFullYear(), cur.getMonth(), 1);
    const start = new Date(first);
    const offset = (first.getDay() + 6) % 7; // 周一=0
    start.setDate(1 - offset);
    const grid = [];
    for (let r=0; r<6; r++){
      const row=[];
      for (let c=0; c<7; c++){
        const d=new Date(start); d.setDate(start.getDate()+r*7+c);
        row.push(d);
      }
      grid.push(row);
    }
    return grid;
  };
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

  async function httpJSON(url, opts={}){
    const res = await fetch(url, {credentials:'include', ...opts});
    if (res.redirected && res.url.includes('/login')) { console.warn('[httpJSON] redirected to login');
      window.location.href = res.url;
      throw new Error('Not logged in');
    }
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
    }
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  // ---------- Header ----------
  function Header({view, setView, timeSettings, setShowTimeSettings, navigate, rangeLabel, user, eventCount}){
    return (
      <div className="border-b-2 border-black pb-4 mb-4">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            {user ? (
              <form method="post" action="/logout">
                <button type="submit" className="btn">退出登录</button>
              </form>
            ) : (
              <>
                <a href="/login" className="btn btn-ghost">登录</a>
                <a href="/register" className="btn">注册</a>
              </>
            )}

            <span className="px-2 py-1 border-2 border-black">evs: {eventCount}</span>
            <h1 className="text-2xl font-bold">calendar</h1>
            <span className="px-2 py-1 border-2 border-black">{rangeLabel}</span>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={()=>setShowTimeSettings(true)} className="btn btn-ghost flex items-center gap-2">
              ⏱ {pad(timeSettings.startHour)}:00–{pad(timeSettings.endHour)}:00
            </button>
            <div className="flex border-2 border-black">
              {['day','3day','week','month'].map(k=> (
                <button
                  key={k}
                  onClick={()=>setView(k)}
                  className={`px-4 py-2 border-r-2 border-black last:border-r-0 ${view===k?'bg-black text-white':'hover:bg-gray-100'}`}
                >
                  {k==='day' ? '日' : (k==='3day' ? '3天' : (k==='week' ? '周' : '月'))}
                </button>
              ))}
            </div>
            <button onClick={()=>navigate(-1)} className="btn btn-ghost">←</button>
            <button onClick={()=>navigate(1)} className="btn btn-ghost">→</button>
          </div>
        </div>
      </div>
    );
  }

  // ---------- TimeGrid (Day/3-Day/Week) ----------
  function TimeGridMulti({dates, events, onCreateRange, onEventClick, timeSettings}){
    const hours = useMemo(()=>{
      const arr=[]; const {startHour,endHour}=timeSettings;
      if(startHour<=endHour){ for(let h=startHour;h<=endHour;h++) arr.push(h); }
      else { for(let h=startHour;h<24;h++) arr.push(h); for(let h=0;h<=endHour;h++) arr.push(h); }
      return arr;
    },[timeSettings]);

    const wrapRef = useRef(null);
    const rbRef = useRef(null);
    const stateRef = useRef({dragging:false, col:0, startY:0, startHM:''});

    const todayStr = ymd(new Date());
    const colCount = dates.length;

    function hmFromY(y, rect){
      const relY = clamp(y - rect.top, 0, rect.height-1);
      const minute = Math.round((relY % 60)/5)*5;
      const hourIdx = Math.floor(relY/60);
      const h = hours[Math.min(hourIdx, hours.length-1)];
      return pad(h)+':'+pad(minute);
    }
    function colFromX(x, rect){
      const gridLeft = rect.left + 64;
      const usable = rect.width - 64 - 8;
      if (x < gridLeft) return 0;
      const relX = clamp(x - gridLeft, 0, usable-1);
      const cw = usable / colCount;
      return Math.floor(relX / cw);
    }

    function onMouseDown(e){
      const container = wrapRef.current; if(!container) return;
      const rect = container.getBoundingClientRect();
      if(e.clientX - rect.left < 64) return;
      const col = colFromX(e.clientX, rect);
      stateRef.current.dragging = true;
      stateRef.current.col = col;
      stateRef.current.startY = e.clientY;
      stateRef.current.startHM = hmFromY(e.clientY, rect);

      const rb = rbRef.current;
      if(rb){
        const usable = rect.width - 64 - 8;
        const cw = usable / colCount;
        rb.style.display = 'block';
        rb.style.left = (64 + col*cw + 8) + 'px';
        rb.style.width = (cw - 16) + 'px';
        rb.style.top = (e.clientY - rect.top) + 'px';
        rb.style.height = '2px';
      }
      e.preventDefault();
    }
    function onMouseMove(e){
      if(!stateRef.current.dragging) return;
      const rect = wrapRef.current.getBoundingClientRect();
      const y0 = stateRef.current.startY;
      const y1 = e.clientY;
      const top = Math.min(y0,y1) - rect.top;
      const rb = rbRef.current;
      if(rb){
        rb.style.top = clamp(top, 0, rect.height-2) + 'px';
        rb.style.height = Math.max(2, Math.abs(y1 - y0)) + 'px';
      }
      e.preventDefault();
    }
    function onMouseUp(e){
      if(!stateRef.current.dragging) return;
      const rect = wrapRef.current.getBoundingClientRect();
      const y0 = stateRef.current.startY;
      const y1 = e.clientY;
      const moved = Math.abs(y1 - y0);
      const col = stateRef.current.col;
      stateRef.current.dragging = false;
      const rb = rbRef.current; if(rb) rb.style.display='none';
      if(moved < 6) return;

      const startHM = hmFromY(Math.min(y0,y1), rect);
      let endHM = hmFromY(Math.max(y0,y1), rect);
      const [sh,sm] = startHM.split(':').map(Number);
      const [eh,em] = endHM.split(':').map(Number);
      let sMins = sh*60+sm, eMins = eh*60+em;
      if(eMins <= sMins) eMins = sMins + 5;
      endHM = pad(Math.floor(eMins/60)) + ':' + pad(eMins%60);

      const dateStr = ymd(dates[col]);
      onCreateRange(dateStr, startHM, endHM);
    }

    return (
      <div className="border-2 border-black bg-white">
        {/* 列头：横轴日期（含星期，周一开头） */}
        <div className="sticky-top border-b-2 border-black">
          <div className="flex" style={{marginLeft:'64px', padding:'6px 8px'}}>
            {dates.map((d,i)=>(
              <div key={i} className="flex-1 text-center font-bold">
                {ymd(d)}&nbsp;{['一','二','三','四','五','六','日'][ (d.getDay()+6)%7 ]}
              </div>
            ))}
          </div>
        </div>

        {/* 主网格 */}
        <div
          ref={wrapRef}
          className="relative select-none"
          style={{height: ( ( (timeSettings.endHour - timeSettings.startHour + 24) % 24 ) + 1 )*60 + 'px'}}
          onMouseDown={onMouseDown}
          onMouseMove={onMouseMove}
          onMouseUp={onMouseUp}
        >
          <div ref={rbRef} className="rubber" style={{display:'none'}}></div>

          {hours.map((h)=> (
            <div key={h} className="relative" style={{height:'60px'}}>
              <div className="absolute w-full border-t border-gray-400" style={{top:0}}/>
              <div className="absolute left-0 top-0 timecol h-full bg-gray-50 border-r border-black flex items-start pt-1 px-2">
                <span className="text-xs font-mono">{h===0?'12AM':h<12?`${h}AM`:h===12?'12PM':`${h-12}PM`}</span>
              </div>
              <div className="absolute top-0 h-full" style={{
                left:'64px', right:'8px', display:'grid',
                gridTemplateColumns:`repeat(${dates.length}, 1fr)`, gap:'8px'
              }}>
                {dates.map((_,ci)=>(
                  <div key={ci} className="relative h-full">
                    <div className="absolute w-full border-t border-gray-300" style={{top:'30px'}}/>
                    {[15,45].map(m=> (
                      <div key={m} className="absolute left-0 w-3 border-t border-gray-400" style={{top:`${m}px`}}/>
                    ))}
                  </div>
                ))}
              </div>
            </div>
          ))}

          {/* 事件块 */}
          {events.map(ev=>{
            const dIndex = dates.findIndex(d=> ymd(d)===ev.date);
            if(dIndex===-1) return null;
            const [sh,sm]=ev.time.split(':').map(Number);
            const [eh,em]=(ev.endTime||ev.time).split(':').map(Number);
            const si = hours.indexOf(sh); if(si===-1) return null;
            const ei = hours.indexOf(eh);
            const sy = si*60 + sm, ey = (ei!==-1? ei*60+em : sy+60);
            const h = Math.max(ey-sy, 25);

            const gridLeft = 64, gridRightPad = 8;
            return (
              <div key={ev.id}
                onClick={(e)=>{e.stopPropagation(); onEventClick(ev);}}
                className="absolute z-10 border-2 border-black bg-gray-200 hover:bg-gray-300 cursor-pointer"
                style={{
                  top: (sy+1)+'px',
                  height:(h-2)+'px',
                  left: `calc(${gridLeft}px + (${dIndex} * (100% - ${gridLeft+gridRightPad}px) / ${dates.length}) + 8px)`,
                  width: `calc((100% - ${gridLeft+gridRightPad}px)/${dates.length} - 16px)`
                }}>
                <div className="p-1.5 h-full overflow-hidden">
                  <div className="font-bold text-sm truncate">{ev.title}</div>
                  {h>35 && <div className="text-xs">{ev.time} - {ev.endTime}</div>}
                </div>
              </div>
            )
          })}

          {/* 今日时间线（仅“今天”所在列显示） */}
          {dates.map((d,ci)=>{
            if(ymd(d)!==todayStr) return null;
            const now = new Date();
            const y = hours.indexOf(now.getHours());
            if(y===-1) return null;
            const py = y*60 + now.getMinutes();
            const gridLeft = 64, gridRightPad = 8;
            return (
              <div key={'now-'+ci}
                   className="absolute z-30 border-t-2 border-black"
                   style={{
                    top:py+'px',
                    left: `calc(${gridLeft}px + (${ci} * (100% - ${gridLeft+gridRightPad}px) / ${dates.length}) + 8px)`,
                    width: `calc((100% - ${gridLeft+gridRightPad}px)/${dates.length} - 16px)`
                   }}/>
            );
          })}
        </div>
      </div>
    );
  }

  // ---------- Month Grid ----------
  function MonthGrid({monthDate, events, onDayClick, onEventClick}){
    const matrix = useMemo(()=> monthMatrix(monthDate), [monthDate]);

    const evMap = useMemo(()=>{
      const m = new Map();
      for(const ev of events){
        if(!m.has(ev.date)) m.set(ev.date, []);
        m.get(ev.date).push(ev);
      }
      return m;
    }, [events]);

    return (
      <div className="border-2 border-black bg-white">
        <div className="grid grid-cols-7 border-b-2 border-black sticky-top">
          {['一','二','三','四','五','六','日'].map((w,i)=>(
            <div key={i} className="text-center font-bold p-2">{w}</div>
          ))}
        </div>
        <div className="grid grid-cols-7 gap-0">
          {matrix.flat().map((d,idx)=>{
            const ds = ymd(d);
            const inMonth = d.getMonth()===monthDate.getMonth();
            const dayEvents = evMap.get(ds)||[];
            return (
              <div
                key={idx}
                className={`border border-gray-300 min-h-[96px] p-1 ${inMonth?'bg-white':'bg-gray-100 opacity-70 cursor-not-allowed'}`}
                onClick={(e)=>{ if(!inMonth) return; e.stopPropagation(); onDayClick(ds); }}
              >
                <div className="text-xs font-bold">{d.getDate()}</div>
                <div className="mt-1 space-y-1">
                  {dayEvents.slice(0,3).map(ev=>(
                    <div key={ev.id}
                         onClick={(e)=>{ e.stopPropagation(); onEventClick(ev); }}
                         className="text-[11px] truncate px-1 border border-black bg-gray-200 hover:bg-gray-300 cursor-pointer">
                      {ev.time} {ev.title}
                    </div>
                  ))}
                  {dayEvents.length>3 && <div className="text-[11px] text-gray-600">+{dayEvents.length-3} more</div>}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  // ---------- App ----------
  function App(){
    const [view, setView] = useState('week');   // 默认周视图
    const [date, setDate] = useState(new Date());
    const [events, setEvents] = useState([]);
    const [formOpen, setFormOpen] = useState(false);
    const [editing, setEditing] = useState(null);
    const [form, setForm] = useState({title:'', date: ymd(new Date()), time:'09:00', endTime:'10:00', notes:'', repeat:'none'});
    const [timeSettings, setTimeSettings] = useState({ startHour: 7, endHour: 22 });
    const [showTimeSettings, setShowTimeSettings] = useState(false);
    const [loading, setLoading] = useState(false);
    const [user, setUser] = useState(false);
    useEffect(()=>{
      fetch('/status', {credentials:'include'})
        .then(r=>r.json())
        .then(d=> { console.log('[status]', d); setUser(!!d.user); })
        .catch(err=> { console.warn('[status] failed', err); setUser(false); });
    },[]);

    function visibleRange(d, v){
      if(v==='day'){ const s=new Date(d); s.setHours(0,0,0,0); return [s, addDays(s,1)]; }
      if(v==='3day'){ const s=new Date(d); s.setHours(0,0,0,0); return [s, addDays(s,3)]; }
      if(v==='week'){ const s=startOfWeek(d); return [s, addDays(s,7)]; }
      const s = new Date(d.getFullYear(), d.getMonth(), 1);
      const e = new Date(d.getFullYear(), d.getMonth()+1, 1);
      return [addDays(s,-7), addDays(e,7)];
    }

    async function load(){
      setLoading(true);
      try{
        const [s,e] = visibleRange(date, view);
        const q = new URLSearchParams({ start: s.toISOString(), end: e.toISOString() }).toString();
        console.log('[load] range', s.toISOString(), e.toISOString());
        const arr = await httpJSON('/api/events?'+q);
        console.log('[load] got', Array.isArray(arr)? arr.length : arr, arr);
        const mapped = (arr||[]).map(e=>{
          const s = fromISO(e.start);
          const ee = fromISO(e.end);
          return {
            id: e.id, title: e.title||'', notes:e.notes||'',
            date: ymd(s),
            time: pad(s.getHours())+':'+pad(s.getMinutes()),
            endTime: pad(ee.getHours())+':'+pad(ee.getMinutes()),
            rrule: e.rrule || null
          };
        });
        setEvents(mapped);
      }catch(err){
        console.error(err);
        alert('加载事件失败：'+err.message);
      }finally{
        setLoading(false);
      }
    }
    useEffect(()=>{ load(); },[view, date]);

    const navigate = (dir)=>{
      const d = new Date(date);
      if(view==='day'){ d.setDate(d.getDate()+dir); }
      else if(view==='3day'){ d.setDate(d.getDate()+3*dir); }
      else if(view==='week'){ d.setDate(d.getDate()+7*dir); }
      else { d.setMonth(d.getMonth()+dir); }
      setDate(d);
    };

    function openCreateRange(dateStr, startHM, endHM){
      setEditing(null);
      setForm({ title:'', date:dateStr, time:startHM, endTime:endHM, notes:'', repeat:'none'});
      setFormOpen(true);
    }
    function openCreateAtDay(dateStr){
      setEditing(null);
      setForm({ title:'', date:dateStr, time:'09:00', endTime:'10:00', notes:'', repeat:'none'});
      setFormOpen(true);
    }

    async function save(){
      const payload = {
        title: form.title.trim(),
        notes: form.notes || '',
        start: toISO(form.date, form.time),
        end: toISO(form.date, form.endTime),
        rrule: (form.repeat==='none') ? null : { freq: form.repeat.toUpperCase(), dtstart: toISO(form.date, form.time) }
      };
      try{
        if(!payload.title) throw new Error('标题不能为空');
        if(new Date(payload.end) <= new Date(payload.start)){
          const dt = new Date(payload.start);
          dt.setMinutes(dt.getMinutes()+5);
          payload.end = dt.toISOString();
        }
        if(editing){
          console.log('[save:PUT] payload', payload);
          await httpJSON('/api/events/'+editing.id, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }else{
          console.log('[save:POST] payload', payload);
          await httpJSON('/api/events', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }
        setFormOpen(false); setEditing(null);
        await load();
      }catch(err){
        console.error(err);
        alert('保存失败：'+err.message);
      }
    }

    async function remove(onlyThis=false){
      if(!editing) return;
      try{
        const dateISO = toISO(editing.date, editing.time);
        const url = onlyThis && editing.rrule
          ? `/api/events/${editing.id}?exdate=${encodeURIComponent(dateISO)}`
          : `/api/events/${editing.id}`;
        await httpJSON(url, {method:'DELETE'});
        setFormOpen(false); setEditing(null);
        await load();
      }catch(err){
        console.error(err);
        alert('删除失败：'+err.message);
      }
    }

    const rangeLabel = (()=> {
      if(view==='day') return ymd(date);
      if(view==='3day') return `${ymd(date)} ~ ${ymd(addDays(date,2))}`;
      if(view==='week'){
        const s = startOfWeek(date), e = addDays(s,6);
        return `${ymd(s)} ~ ${ymd(e)}`;
      }
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}`;
    })();

    const datesForView = (()=> {
      if(view==='day') return [new Date(date)];
      if(view==='3day') return [0,1,2].map(i=> addDays(date,i));
      if(view==='week'){ const s = startOfWeek(date); return [0,1,2,3,4,5,6].map(i=> addDays(s,i)); }
      return [];
    })();

    return (
      <div className="min-h-screen bg-white">
        <div className="max-w-6xl mx-auto p-4">
          <Header
            view={view}
            setView={setView}
            timeSettings={timeSettings}
            setShowTimeSettings={setShowTimeSettings}
            navigate={navigate}
            rangeLabel={rangeLabel}
          />

          {loading && <div className="text-sm text-gray-600 mb-2">加载中…</div>}

          {view==='month' ? (
            <MonthGrid
              monthDate={date}
              events={events}
              onDayClick={ds=> openCreateAtDay(ds)}
              onEventClick={ev=> { setEditing(ev); setForm({...ev, repeat: ev.rrule? ev.rrule.freq.toLowerCase():'none'}); setFormOpen(true); }}
            />
          ) : (
            <TimeGridMulti
              dates={datesForView}
              events={events}
              timeSettings={timeSettings}
              onCreateRange={openCreateRange}
              onEventClick={(ev)=>{ setEditing(ev); setForm({...ev, repeat: ev.rrule? ev.rrule.freq.toLowerCase():'none'}); setFormOpen(true); }}
            />
          )}
        </div>

        {/* 时间设置弹窗 */}
        {showTimeSettings && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dialog p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">时间设置</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">开始</label>
                  <select className="w-full border-2 border-black p-2"
                    value={timeSettings.startHour}
                    onChange={e=> setTimeSettings(s=>({...s, startHour: parseInt(e.target.value)}))}>
                    {Array.from({length:24}, (_,h)=> <option key={h} value={h}>{String(h).padStart(2,'0')}:00</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">结束</label>
                  <select className="w-full border-2 border-black p-2"
                    value={timeSettings.endHour}
                    onChange={e=> setTimeSettings(s=>({...s, endHour: parseInt(e.target.value)}))}>
                    {Array.from({length:24}, (_,h)=> <option key={h} value={h}>{String(h).padStart(2,'0')}:00</option>)}
                  </select>
                </div>
              </div>
              <div className="flex gap-3 mt-6">
                <button className="btn btn-ghost flex-1" onClick={()=> setShowTimeSettings(false)}>取消</button>
                <button className="btn flex-1" onClick={()=> setShowTimeSettings(false)}>保存</button>
              </div>
            </div>
          </div>
        )}

        {/* 新建/编辑事件弹窗 */}
        {formOpen && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dialog p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">{editing? '编辑事件':'新事件'}</h3>
              <div className="grid gap-3">
                <label className="text-sm font-bold">标题
                  <input className="w-full border-2 border-black p-2" value={form.title}
                         onChange={e=> setForm({...form, title:e.target.value})} placeholder="事件标题"/>
                </label>
                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm font-bold">日期
                    <input type="date" className="w-full border-2 border-black p-2" value={form.date}
                           onChange={e=> setForm({...form, date:e.target.value})}/>
                  </label>
                  <label className="text-sm font-bold">重复
                    <select className="w-full border-2 border-black p-2" value={form.repeat}
                            onChange={e=> setForm({...form, repeat:e.target.value})}>
                      <option value="none">不重复</option>
                      <option value="daily">每天</option>
                      <option value="weekly">每周</option>
                    </select>
                  </label>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <label className="text-sm font-bold">开始
                    <input type="time" className="w-full border-2 border-black p-2" value={form.time}
                           onChange={e=> setForm({...form, time:e.target.value})}/>
                  </label>
                  <label className="text-sm font-bold">结束
                    <input type="time" className="w-full border-2 border-black p-2" value={form.endTime}
                           onChange={e=> setForm({...form, endTime:e.target.value})}/>
                  </label>
                </div>
                <label className="text-sm font-bold">备注
                  <textarea className="w-full border-2 border-black p-2 h-20 resize-none" value={form.notes}
                            onChange={e=> setForm({...form, notes:e.target.value})}/>
                </label>
              </div>
              <div className="flex gap-3 mt-6">
                <button className="btn btn-ghost flex-1"
                  onClick={()=> { setFormOpen(false); setEditing(null); }}>
                  取消
                </button>
                {editing && <button className="btn flex-none" onClick={()=> remove(false)}>删除</button>}
                {editing && editing.rrule && <button className="btn flex-none" onClick={()=> remove(true)}>仅删这一次</button>}
                <button className="btn flex-1" onClick={save} disabled={!form.title.trim()}>
                  {editing? '保存':'创建'}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
{% endraw %}
</body>
</html>
